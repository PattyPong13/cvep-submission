var chat_log = {
    "Group": [
        ["Adi", "Ehhhh @Bryan @Patrick how did your H2 math go?"],
        ["Hilman", "Huh their paper ended alr ah? Morning paper?"],
        ["Player", "Wahhh sian"],
        ["Player", "Couldn't seem to do all the questions"],
        ["Player", "@Hilman Ya, morning paper,1h paper only. It started at 8am"],
        ["Hilman", "F"],
        ["Hilman", "Bruh I thought yall could use GDC"],
        ["Adi", "Ya bro this paper all the qns can use GDC right?"],
        ["Player", "I mean yea we could but they put in weird variables"],
        ["Player", "@Patrick could you do the question on the ducks?"],
        ["Adi", "what ducks"],
        ["Player", "Some stupid question on size of ducks in diff seasons"],
        ["Player", "They made us find SD by hand cos they put in some weird algebra"],
        ["Hilman", "Wah thank God I took H1 math"],
        ["Adi", "Wait SD by hand? wth"],
        ["Hilman", "No lah got some formula for that, very easy one"],
        ["Player", "Okay FLEX"],
        ["Player", "I forgot which SD formula to use so hopefully I got it right"],
        ["Adi", "Aiya, that’s just 1 question right?"],
        ["Player", "UHM WELLLL the entire stats paper was pretty much a mess so..."],
        ["Adi", "LOL NEVERMIND THEN, FORGET ABT IT"],
        ["Adi", "Finish alr lah"],
        ["Hilman", "HAHAHAHAHA YA nevermind, cannot do anything alr"],
        ["Player", "Tsk, yeah, what to do?"],
        ["Player", "Just hope for the best"],
        ["Adi", "Eh nevermind la we go celebrate first, we study for too long alr"],
        ["Player", "LOL WHY I ALWAYS GO OUT W YALL?"],
        ["Player", "Why I no gf to go out with ah T.T"],
        ["Hilman", "Too bad :P why ur face so ugly LMAO"],
        ["Adi", "wah Hil why so toxic?"],
        ["Adi", "Not like your face any better"],
        ["Adi", "As Bryan put it, ur face is rather bland"],
        ["Player", "HAHAHA Steal my line ah"],
        ["Hilman", "Tsk better than having 10000 pimples like Patrick"],
        ["Adi", "Don’t so toxic lah bro"],
        ["Hilman", "EHHH Anyway so I wanted to ask if yall free later this afternoon, since exams ended"],
        ["Player", "LOL I was just gonna game so ya I guess"],
        ["Adi", "bruh I busy w chess tournament leh"],
        ["Hilman", "Aiya you win so many competitions alr can miss one"],
        ["Player", "Adi, you no need practice anyway, you’re too good"],
        ["Adi", "ye la ye la"],
        ["Adi", "So, what do you have in mind?"],
        ["Hilman", "We've studied so long alr, there's so many new movies that came out"],
        ["Adi", "EH YAA"],
        ["Adi", "THE INFINITY WAR MOVIE JUST CAME OUT"],
        ["Player", "Infinity War?"],
        ["Player", "OH the Avengers one"],
        ["Adi", "Ya"],
        ["Hilman", "LOL I only watch for the action"],
        ["Player", "Same, I just like the graphics and effects"],
        ["Adi", "How dare youuu"],
        ["Hilman", "Eh there’s a movie at 7pm"],
        ["Hilman", "Just nice we eat dinner first, watch alr, then go get drinks"],
        ["Adi", "Woi we underage you know"],
	["Player", "Ehh nice one lah"],
	["Player", "Meet at 5pm?"],
	["Hilman", "@Adi bro I just meant dessert and stuff"],
	["Hilman", "@Bryan sounds good. Movie is at Vivo City so we can just meet there"],
	["Adi", "Ah, just nice, near my house. Okay, see yall"],
	["Adi", "@Patrick you coming?"],
	["Player", "@Patrick ya, you free also right?"],
	["Patrick", "Uhm"],
	["Patrick", "I think yall go ahead without me, I've got stuff"],
    ],
    "Patrick" : [

    ],
    "Hilman": [

    ],
    "Adi": [

    ],
    "Marianne": [

    ]
};

var chat_elements = {
    "Group": loadChat("Group"),
    "Patrick": loadChat("Patrick"),
    "Hilman": loadChat("Hilman"),
    "Adi": loadChat("Adi"),
    "Marianne": loadChat("Marianne")
};

var diary_entries = [
    [
        "New Year's Day?!", "1 January 2021",
        `Dear Diary, (haha, what a funny thing to say) 
        <br /><br />
        How should I start this? Hilman has been telling me that I should start keeping diary entries to help me “reflect” on myself and things 
        around me. He says it helps him note down key events and moments to which he can look back on. I guess I’ll keep a record of important 
        events just in case I forget. New year, new me?
        <br /><br />
        This new year feels kind of surreal. Time has passed in a flash...Seems about the right time to start thinking about adulthood as well - 
        what is independance, what is the significance of friendships going forward...
        <br /><br />
        Too many thoughts to fit in one entry
        <br /><br />
        Best regards? Bryan.`
    ],
    [
        "First Day of JC :P", "04 February 2021",
        `Dear Diary,
        <br /><br />
        It’s official. I’ve stepped into my new JC. Dang this feels weird but… I’m finally a JC student and honestly - the sight of those three 
        idiots in uniform really makes my heart feel fuzzy. Urgh I hate it when I feel like that but - The. Gang. Is. Back. For that, I am always 
        grateful.  Hopefully we’ll be in the same class too. 
        <br /><br />
        Fun nugget! Patrick was so certain about making it here, that he bought the school uniform before the year even started. Spoil market… 
        But I mean, of course he was going to get in, his O’s were straight As. This man’s always after excellence and perfection.
        <br /><br />
        On a side note, I gave Hilman a peek at my diary and he commented that it was very “bland”, and said that my entries should be more flavourful and exciting. Why do diaries have to be exciting anyway? I say his face is the one that looks bland. I kinda like that insult… I’ll use it next time I see him. Anyway, Adi did suggest I should add pictures. Feeling lazy...
        <br /><br />
        Best Regards? 
        <br /><br />
        P.S. I still don’t know how to end a diary entry haha`
    ],
    [
        "Class bonding", "14 April 2021",
        `Dear Diary,
        <br /><br />
        It’s been a while… JC has been a rush - choir rehearsals, a crap load of homework and all this new “social dynamics” I need to watch out for. Anyway, something interesting happened today. Our class went out for a bonding sesh and I noticed Patrick and Marianne sticking together a little bit too much? He even seemed to get a bit down when this popular guy Ethan started chatting with her.
        <br /><br />
        I’m sure Patrick likes her… even I would. He started smiling so much and dodged all the questions that Adi was asking him. The WHOLE train ride back home, he was just talking about her. I’ve never seen him so happy before.
        <br /><br />
        I don’t really know whether I should feel sad or happy. I’m not comfortable talking to girls, especially when most of them aren’t suited to my style. Maybe Patrick will be the first to go and then Adi and Haliman… Haha I’ll lose all my friends. 
        <br /><br />
        Patrick’s JC goals are questionable…
        <br /><br />
        Cheers`    
    ],
    [
        "Achievement Unlocked: Flawless Performance", "13 June 2021",
        `Dear Diary,
        <br /><br />
        THE CHOIR DID IT!! OUR FIRST JC PERFORMANCE IN THE CHOIR! At the SYF no less! Patrick and I had so much fun! Adi and Hilman were watching and they enjoyed the performance so much! Even Hilman, who is a music genius, only had good things to say! A FIRST FOR HILMAN! HAHAHAHAHA Adi was really impressed by the harmony of the costumes and set. I am so glad it all went well.
        <br /><br />
        Honestly, it was pretty nerve-wrecking, but hey we made it. Patrick has been so jittery about this performance for weeks. It was so funny to see him talk about it everyday. DAMN that guy can talk and talk. He even mentioned how his parents would be watching and he was so excited to show them what the choir had been working on. 
        <br /><br />
        I hope I can keep this energy and happiness up all the way till the end of the year. Hilman, being his cynical self, did say that we have to start focussing on studying soon though. Well, this was a fun energy boost should last a while
        <br /><br />
        Bryan.` 
    ],
    [
        "Heat is turning up", "26 July 2021",
        `Dear Diary,
        <br /><br />
        The school’s National Day ceremony is less than two weeks away and per annual tradition, the Choir will be performing a piece for it. HOWEVER, we are still fumbling some parts! So far removed we are from the glory days we experienced  during SYF. Why didn’t we just do the same piece again one may ask. I call it the classic case of complacency. Many of us were in our own heads being drunk on the success that we have experienced and felt that we could do anything. Arranging, rehearsing and polishing an entirely new song within a month and a half was definitely not a good idea. Patrick seems to be almost on the verge of breaking down. He’s never been an especially quick learner, and I’m sure the reduced runway isn’t helping either. But we all know that he’ll put in the extra effort to make it work, so he’ll be fine. 
        <br /><br />
        Adi will also be going to the UK for the next two weeks to compete in some high level chess competition, best of luck to him.` 
    ],
    [
        "Not the best parade", "7 August 2021",
        `Dear Diary,
        <br /><br />
        Dang was it a hectic day. I don’t think I’ll ever get used to the early and long hours of performance days no matter how many times I do it. Waking up at 5 to be in school by 5.30 for final rehearsals, followed by almost an hour for costumes and makeup?! That’s almost inhumane. Even so, I’m grateful that it was about as smooth as it could go, with no major hiccups less a missing set of makeup. (which only served further slow down the process) 
        <br /><br />
        The performance, however, was about as bad as one could make it out to be, of no (almost) fault of our own. Even after the tech run in the morning, the sound systems decided to fail us in the middle of the performance, which threw us into arrays of confusion. Never have we ever even been briefed about how to react to a sudden failure of the mics. Some of us started looking around while others attempted to sing louder. Disaster. Fortunately for us, our teacher was among the audience and managed to settle us down with his familiar gestures, directing us to perform as per practice. 
        <br /><br />
        In the aftermath, there was crying, ranting and raging. Patrick in particular, was beside himself as he went on and on about the amount of time he spent to perfect his role for it to be foiled by the sound system of all things. I, on the other hand, was just glad that the fiasco was over and tried to get Patrick onto the same train of thought. Adi and Hilman got a good laugh out of this less than ideal scenario, and they thoroughly enjoyed themselves watching the performance and we poked some at Patrick as well. Bad choice? Maybe. But at least we got him to smile and laugh it off.
        <br /><br />
        Never again.` 
    ],
    [
        "Tis the season to be studying", "27 September 2021",
        `Dear Diary,
        <br /><br />
        Day after day staying behind in school with Adi, Hilman and Patrick and sometimes Marianne may seem like the most boring thing to ever do, but it’s wild the kind of things you discover through studying with others. Adi has somehow gotten messier over the years, especially with his ever growing collection of highlighters for various colour coding. (he’s gotten another 6 shades since mid-years) Hilman is doing his thing, being good with all the theoretical concepts, but struggling with picturing flow for practical based questions. Patrick on the other hand, is almost always flustered, burying his head in the books, trying to master every aspect of every subject. I sometimes wonder how he manages to stay sane with the sheer number of hours he puts into studying. 
        <br /><br />
        JC is a crazy world, and there’s still so much more ahead of us. I personally don’t quite like studying, and it hurts my head to even think about the entire pile that has to be gone through to be adequately ready for exams. I’ve since learnt over the years to focus on the short term goals to feel more tangible progress in this trudge towards competency, but it is hard sometimes. Wonder what uni will be like..
        <br /><br />
        Tired and still lazy.` 
    ]
];

decision_log = [

];

var current_chat = "";
var message_notif = new Audio("assets/new_message.mp3");

//constructing the decision tree
class TreeNode {
    constructor(optionText, gameEvent) {
        this.option = optionText;
        this.gameEvent = gameEvent;
        this.descendants = [];
    }
}

var decision_tree = [];

current_decision = null;

//helper sleep function from https://stackoverflow.com/questions/951021/what-is-the-javascript-version-of-sleep 
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// Onclick event handler to swap diary entry
function changeDiaryEntry(entry_num) {
    var diary_entry = document.getElementById('diary-entry');
    if (entry_num > diary_entries.length - 1) {
        diary_entry.children[0].innerHTML = "Diary entry does not exist";
        diary_entry.children[1].innerHTML = "";
        diary_entry.children[2].innerHTML = "";
    } else {
        diary_entry.children[0].innerHTML = diary_entries[entry_num][0];
        diary_entry.children[1].innerHTML = diary_entries[entry_num][1];
        diary_entry.children[2].innerHTML = diary_entries[entry_num][2];
    }

    diary_entry.children[2].scrollTop = 0;
}

// Creates a message div element
function newMessage(person, chat_contents) {
    var message_container = document.createElement('div');
    var person_name = document.createElement('p');
    var message_content = document.createElement('p');
    
    if (person == "Player") {
        message_container.setAttribute("class", "user");
        person_name.innerHTML = "You";
    } else {
        message_container.setAttribute("class", "other-user");
        person_name.innerHTML = person;
    }

    person_name.setAttribute("class", person);
    message_content.innerHTML = chat_contents;

    message_container.appendChild(person_name);
    message_container.appendChild(message_content);

    return message_container;
}

// Returns a chat-window div with all the chats appended to it as children (Used for initial chat loading)
function loadChat(chat_name) {
    var new_chat_window = document.createElement('div');
    new_chat_window.setAttribute('id', 'chat-window');

    var new_chat_log = chat_log[chat_name];
    
    for (var i = 0; i < new_chat_log.length; i++) {
        var message_container = newMessage(new_chat_log[i][0], new_chat_log[i][1]);
        new_chat_window.appendChild(message_container);
    }

    current_chat = chat_name;
    return new_chat_window;
}

// Onclick event handler to swap chat group
function swapToNewChat(person) {
    document.getElementById('chat-window').remove();
    document.getElementById('messenger-main').appendChild(chat_elements[person]);

    // auto scrolls down
    chat_elements[person].scrollTop = chat_elements[person].scrollHeight;
}

async function addMessageEvent(chat, message, sound, sleeptime) {
    await sleep(sleeptime);
    sound.play();
    chat.appendChild(message);
    chat.scrollTop = chat.scrollHeight;
}

function addDiaryEvent(diary_entry) {
    diary_entries.push(diary_entry);
    var diary_list = document.getElementById("diary-list");
    var new_entry = document.createElement('div');
    var entry_num = diary_list.children.length;
    new_entry.addEventListener("click", function() {
        changeDiaryEntry(entry_num);
    })
    new_entry.textContent = "Diary Entry " + String(diary_list.children.length + 1) + " - " + diary_entry[0];
    diary_list.appendChild(new_entry);
    diary_list.scrollTop = diary_list.scrollHeight;
}

// Builds the decision tree.
function buildDecisionTree() {
    //Building option pathway for Scenario 1
    var startNode = new TreeNode("root", null);
    var neutralOption = new TreeNode("OK, join us next time if you can!", scenario1Neutral);
    var probingOption = new TreeNode("What do you have on?", scenario1Probing);
    startNode.descendants.push(neutralOption);
    startNode.descendants.push(probingOption);
    probingOption.descendants.push(new TreeNode("Alright, hope everything is ok, let us know if you need anything", scenario1ProbingEnd));
    probingOption.descendants.push(new TreeNode("[Don't probe]", scenario1ProbingEnd));

    current_decision = startNode;
}

// Onclick option event handler
function processOption(option) {
    if (option > current_decision.descendants.length - 1) {
        return;
    }

    current_decision = current_decision.descendants[option];
    if (current_decision.option[0] == '[') {
        if (current_decision) {
            current_decision.gameEvent();
        }
    } else {
        addMessageEvent(chat_elements['Group'], newMessage("Player", current_decision.option), message_notif, 0);
        if (current_decision) {
            current_decision.gameEvent();
        }
    }
}

// Displays the new options (descendants of the current decision node)
function displayOption(decisions) {
    for (var i = 0; i < decisions.length; i++) {
        var option_box = document.getElementById("option" + String(i + 1));
        option_box.textContent = decisions[i].option;
    }

    for (var j = decisions.length; j < 4; j++) {
        var option_box = document.getElementById("option" + String(j + 1));
        option_box.textContent = "";
    }
}

async function startGame() {
    var group = chat_elements['Group'];

    await addMessageEvent(group, newMessage("Hilman", "Ey bros anyone up for some picnic?"), message_notif, 1000);
    await addMessageEvent(group, newMessage("Adi", "Eh I onz"), message_notif, 1000);
    await addMessageEvent(group, newMessage("Patrick", "I not free sorry."), message_notif, 2000);

    displayOption(current_decision.descendants);
}

function scenario1Neutral() {
    var message_notif = new Audio("assets/new_message.mp3");
    var group = chat_elements['Group'];

    addMessageEvent(group, newMessage("Patrick", "Sure."), message_notif, 1000);
    displayOption(current_decision.descendants);

    addDiaryEvent([
        "LAST DAY OF J1 FYE", "09 November 2021",
        `Dear Diary,
        <br /><br />
        WE’VE MADE IT!! Our last exam is finally completed!! Wow, it has been a long, painful journey. I’m so, so happy to finally be done with it. Long break ahead!! I think that last H2 Math paper went as well as I could have expected it to. Not ideal, but I did my best. 
        <br /><br />
        The rest seem pretty relieved that exams have ended too. Both Adi and Hilman have not hesitated to engage in their hobbies right away, since their exams ended yesterday. Hmm maybe I should have followed them and taken H1 math too. Adi has been training “hard” for his upcoming chess competition. HAHAHA it doesn’t seem hard at all for him and he seems to enjoy himself. Plus, he is really, really good at it. 
        <br /><br />
        Hilman has been producing Da Vinci-level art. Damn those art pieces truly are a sight to behold. That guy is just too talented already, too much skill. Honestly, I would have just been playing games and rotting.
        <br /><br />
        Anyway, the three of us went out today to the movies. It’s been awhile since I watched a movie in the cinema and truly experienced the sounds and visual effects. I’ve missed having time to go out and enjoy myself like this. We watched Avengers: Infinity War. It was epic! It was so cool to see all the pieces of the MCU come together. I can’t wait for part 2 of the movie!
        <br /><br />
        We had a good time discussing the movie and possible plots and subplots for part 2 over drinks. Adi went full-nerd on the whole thing. He went off rambling about “themes and character development”. He also kept going on about “time travel” and ”comic-book canon”. You know what I think about it? It’s pretty lame and it’s complex, I can’t be bothered to think much. Who even thinks about such stuff anyway… I’m just watching it for the cool effects and funny lines :P
        <br /><br />
        `
    ]);
}

function scenario1Probing() {
    var message_notif = new Audio("assets/new_message.mp3");
    var group = chat_elements['Group'];

    addMessageEvent(group, newMessage("Patrick", "I'm just busy. I can't make it. Sorry to disappoint"), message_notif, 1000);
    displayOption(current_decision.descendants);
    console.log(current_decision);
}

function scenario1ProbingEnd() {
    var message_notif = new Audio("assets/new_message.mp3");
    var group = chat_elements['Group'];

    displayOption(current_decision.descendants);
    addDiaryEvent([
        "LAST DAY OF J1 FYE", "09 November 2021",
        `Dear Diary,
        <br /><br />
        WE’VE MADE IT!! Our last exam is finally completed!! Wow, it has been a long, painful journey. I’m so, so happy to finally be done with it. Long break ahead!! I think that last H2 Math paper went as well as I could have expected it to. Not ideal, but I did my best. 
        <br /><br />
        The rest seem pretty relieved that exams have ended too. Both Adi and Hilman have not hesitated to engage in their hobbies right away, since their exams ended yesterday. Hmm maybe I should have followed them and taken H1 math too. Adi has been training “hard” for his upcoming chess competition. HAHAHA it doesn’t seem hard at all for him and he seems to enjoy himself. Plus, he is really, really good at it. 
        <br /><br />
        Hilman has been producing Da Vinci-level art. Damn those art pieces truly are a sight to behold. That guy is just too talented already, too much skill. Honestly, I would have just been playing games and rotting.
        <br /><br />
        Anyway, the three of us went out today to the movies. It’s been awhile since I watched a movie in the cinema and truly experienced the sounds and visual effects. I’ve missed having time to go out and enjoy myself like this. We watched Avengers: Infinity War. It was epic! It was so cool to see all the pieces of the MCU come together. I can’t wait for part 2 of the movie!
        <br /><br />
        We had a good time discussing the movie and possible plots and subplots for part 2 over drinks. Adi went full-nerd on the whole thing. He went off rambling about “themes and character development”. He also kept going on about “time travel” and ”comic-book canon”. You know what I think about it? It’s pretty lame and it’s complex, I can’t be bothered to think much. Who even thinks about such stuff anyway… I’m just watching it for the cool effects and funny lines :P
        <br /><br />
	    It’s such a pity that Patrick missed this outing though. He really would have enjoyed the movie and hanging out with us. He usually is not one to miss outings and all. We should look out in case he’s having any issues. Oh well, maybe next time then.
        `
    ]);
}

window.onload = function() {
    var chat = document.getElementById('chat-window');
    chat.scrollTop = chat.scrollHeight;

    buildDecisionTree();
    console.log(current_decision);
    swapToNewChat("Group");
    startGame();
}
